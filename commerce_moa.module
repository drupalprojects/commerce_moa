<?php

/**
 * Implements hook_menu().
 */
function commerce_moa_menu() {
  $items = array();

  $items['admin/commerce/config/moa'] = array(
    'title' => 'Minimum Order Amount',
    'description' => 'Configure the default minimum order amount value.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_moa_settings_form'),
    'access arguments' => array('configure store'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Builds the minimum order amount settings form.
 */
function commerce_moa_settings_form($form, &$form_state) {
  $form = array();

  $form['commerce_minimum_order_amount'] = array(
    '#type' => 'textfield',
    '#size' => 15,
    '#title' => t('Minimum Order Amount'),
    '#description' => t('The default minimum order amount. Ex: 11.99 if set 0 then dislable'),
    '#default_value' => commerce_moa_default_value(),
    '#field_suffix' => commerce_default_currency(),
  );

  return system_settings_form($form);
}

/**
 * Return default minimum order amount value, if set is 0 then disable
 */
function commerce_moa_default_value() {
  return variable_get('commerce_minimum_order_amount', 0);
}

/**
 * Implements hook_form_alter().
 */
function commerce_moa_form_alter(&$form, &$form_state, $form_id) {
  $minimum_value = (float) commerce_moa_default_value();

  if ($minimum_value > 0) {
    if (strpos($form_id, 'views_form_commerce_cart_form_') === 0) {
      $form['actions']['checkout']['#validate'] = array_merge($form['#validate'], array('commerce_moa_line_item_views_form_validate'));
    }
  }
}

/**
 * The validate when the checkout button click
 */
function commerce_moa_line_item_views_form_validate($form, &$form_state) {
  $order = commerce_order_load($form_state['order']->order_id);
  $balance = commerce_payment_order_balance($order);
  $total = commerce_currency_amount_to_decimal($balance['amount'], $balance['currency_code']);
  $minimum_value = (float) commerce_moa_default_value();

  if ($total < $minimum_value) {
    form_set_error('order', t('This store requires minimum order of %amount %currency_code.', array('%amount' => $minimum_value, '%currency_code' => $balance['currency_code'])));
  }
}
